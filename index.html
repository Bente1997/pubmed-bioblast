<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PubMed to BioBlast Template</title>
  <style>
    :root {
      --primary: #06038D;
      --background: #f7f7f9;
      --text: #333;
      --accent: #06038D;
      --border-radius: 8px;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background);
      color: var(--text);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    label {
      font-weight: 600;
      margin-top: 1rem;
    }

    input, button, textarea {
      width: 100%;
      max-width: 600px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-top: 1rem;
      transition: background-color 0.2s ease;
    }

    button:hover { background-color: #04026b; }

    textarea {
      height: 300px;
      margin-top: 1rem;
      resize: vertical;
    }

    .pagetitle-wrapper {
      display: flex;
      max-width: 600px;
      width: 100%;
      gap: 0.5rem;
    }
    .pagetitle-wrapper input { flex: 1; }
    .pagetitle-wrapper button { width: auto; margin-top: 0.5rem; }

    .footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>

<body>
  <h1>PubMed to BioBlast Template</h1>

  <label for="email">Your Email (required by NCBI)</label>
  <input id="email" placeholder="your.email@example.com" />

  <label for="pmid">PMID, PubMed Link, DOI, or DOI Link</label>
  <input id="pmid" placeholder="e.g., 39852374" />

  <label for="editor">Editor</label>
  <input id="editor" placeholder="Doe J" />

  <button onclick="generateTemplate()">Generate Template</button>

  <label for="pagetitle">Generated Page Title</label>
  <div class="pagetitle-wrapper">
    <input id="pagetitle" readonly />
    <button onclick="copyPageTitle()">Copy</button>
  </div>

  <label for="output">Generated Template</label>
  <textarea id="output" readonly></textarea>

  <button onclick="copyTemplate()">Copy to Clipboard</button>

  <div class="footer">
    Version 1.20.2026.
  </div>

<script>
    async function generateTemplate() {
      const email = document.getElementById("email").value.trim();
      const input = document.getElementById("pmid").value.trim();
      const editor = document.getElementById("editor").value.trim() || "Plangger M";

      if (!email) { alert("Please enter your email."); return; }
      const pmid = extractPmid(input);
      const doi = extractDoi(input);

      try {
        if (pmid) {
          await generateFromPubMed({ pmid, editor });
        } else if (doi) {
          await generateFromCrossref({ doi, editor });
        } else {
          alert("Couldn't find a PMID or DOI.");
        }
      } catch (e) {
        console.error(e);
        alert("Error fetching data.");
      }
    }

    function extractPmid(str) {
      if (/pubmed\.ncbi\.nlm\.nih\.gov/i.test(str)) {
        const m = str.match(/pubmed\.ncbi\.nlm\.nih\.gov\/(\d+)/i);
        return m ? m[1] : null;
      }
      return /^\d+$/.test(str.trim()) ? str.trim() : null;
    }

    function extractDoi(str) {
      const m = str.match(/10\.\d{4,9}\/[-._;()/:A-Z0-9]+/i);
      return m ? m[0] : null;
    }

    function cleanString(str) {
      return (str || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\x00-\x7F]/g, "");
    }

    function toSentenceCase(title) {
      let t = (title || "").trim().toLowerCase();
      if (!t) return "";
      t = t.charAt(0).toUpperCase() + t.slice(1);
      return t.replace(/:\s*([a-z])/g, (m, p1) => ": " + p1.toUpperCase());
    }

    function yyyyMmNow() { return new Date().toISOString().slice(0, 7); }

    function setOutputs({ template, pageTitle }) {
      document.getElementById("output").value = template || "";
      document.getElementById("pagetitle").value = pageTitle || "";
    }

    // Helper to get the short article ID (e.g., "31" from "metabo15010031")
    function cleanArticleId(rawId) {
        if (!rawId) return "";
        // Remove range suffix
        let id = rawId.split('-')[0];
        // If it's a long string with numbers at the end, take the last few digits
        // Many MDPI/Frontiers papers use [JournalName][Volume][Issue][ArticleID]
        // This regex looks for trailing digits that aren't the whole string
        const match = id.match(/(\d+)$/);
        if (match && id.length > 5) {
            // Usually, the article ID is the last 2-4 digits.
            // If the ID is very long (like metabo15010031), 
            // the '31' is the part we want.
            return parseInt(match[1], 10).toString();
        }
        return id;
    }

async function generateFromPubMed({ pmid, editor }) {
  const summaryResponse = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${pmid}&retmode=json`);
  const summaryData = await summaryResponse.json();
  const result = summaryData?.result?.[pmid];
  if (!result) return;

  const journalAbbrev = result.source || "";
  const title = toSentenceCase(result.title || "");
  const year = (result.pubdate || "").slice(0, 4);
  const volume = result.volume || "";
  const issue = result.issue ? `(${result.issue})` : "";
  
  // Logic to get '31' from '15010031' or use standard pages
  let pages = result.pages || "";
  if (!pages && result.elocationid) {
    const eloc = result.elocationid.replace("doi: ", "");
    // Extract numbers at the very end of the string
    const match = eloc.match(/(\d+)$/);
    if (match) {
      let fullNum = match[1];
      // If it's a long MDPI-style ID (e.g., 15010031), take only the last 1-3 digits
      // that represent the specific article number in that issue.
      pages = fullNum.length > 4 ? parseInt(fullNum.slice(-3), 10).toString() : fullNum;
    }
  }

  const fetchResponse = await fetch(`https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml`);
  const xml = await fetchResponse.text();
  const xmlDoc = new DOMParser().parseFromString(xml, "application/xml");
  const authorNodes = xmlDoc.querySelectorAll("AuthorList > Author");

  const authorsShort = Array.from(authorNodes).map(a => {
    return cleanString(`${a.querySelector("LastName")?.textContent || ""} ${a.querySelector("Initials")?.textContent || ""}`.trim());
  }).join(", ");

  const authorsFull = Array.from(authorNodes).map(a => {
    return cleanString(`${a.querySelector("LastName")?.textContent || ""} ${a.querySelector("ForeName")?.textContent || ""}`.trim());
  }).join(", ");

  const doiMatch = result.elocationid?.match(/10\.\d{4,9}\/[-._;()/:A-Z0-9]+/i);
  const doiUrl = doiMatch ? `https://doi.org/${doiMatch[0]}` : "";
  const pubmedUrl = `https://pubmed.ncbi.nlm.nih.gov/${pmid}`;
  const abstract = Array.from(xmlDoc.querySelectorAll("Abstract > AbstractText")).map(n => n.textContent.trim()).join("\n");
  const keywords = Array.from(xmlDoc.querySelectorAll("KeywordList > Keyword")).map(n => n.textContent.trim()).join(", ");
  const pmcid = result.articleids?.find(id => id.idtype === "pmc")?.value;

  // Final Citation String construction
  let citation = `${journalAbbrev} ${volume}${issue}`;
  if (pages) citation += `:${pages}`;

  const displayTitle = `${authorsShort} (${year}) ${title} ${citation}. ${doiUrl}`;

  const template = `{{Publication
|title=${displayTitle}
|info=[${pubmedUrl} PMID: ${pmid}${pmcid ? " Open Access" : ""}]
|authors=${authorsFull}
|year=${year}
|journal=${journalAbbrev}
|abstract=${abstract}
|keywords=${keywords}
|editor=[[${editor}]]
|mipnetlab=
}}
{{Labeling
|area=
|diseases=
|organism=
|tissues=
|preparations=
|couplingstates=
|pathways=
|instruments=
|additional=${yyyyMmNow()}
}}`;

  setOutputs({ template, pageTitle: `${authorNodes[0]?.querySelector("LastName")?.textContent || "Unknown"} ${year} ${journalAbbrev}` });
}
    async function generateFromCrossref({ doi, editor }) {
      // Crossref path updated with similar year and ID logic
      const r = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
      const data = await r.json();
      const msg = data.message;

      const journal = msg["container-title"]?.[0] || "";
      const title = toSentenceCase(msg.title?.[0] || "");
      const year = msg.published?.["date-parts"]?.[0]?.[0] || "";
      const pages = cleanArticleId(msg.page || "");
      const volume = msg.volume || "";
      const issue = msg.issue ? `(${msg.issue})` : "";
      
      const authorsShort = (msg.author || []).map(a => `${cleanString(a.family)} ${(a.given || "").match(/\b\w/g).join("")}`).join(", ");
      const authorsFull = (msg.author || []).map(a => `${cleanString(a.family)} ${cleanString(a.given)}`).join(", ");

      const displayTitle = `${authorsShort} (${year}) ${title} ${journal} ${volume}${issue}${pages ? ":" + pages : ""}. https://doi.org/${doi}`;

      const template = `{{Publication
|title=${displayTitle}
|info=[https://doi.org/${doi} DOI: ${doi}]
|authors=${authorsFull}
|year=${year}
|journal=${journal}
|abstract=${(msg.abstract || "").replace(/<[^>]+>/g, "")}
|keywords=
|editor=[[${editor}]]
|mipnetlab=
}}
{{Labeling
|area=
|diseases=
|organism=
|tissues=
|preparations=
|couplingstates=
|pathways=
|instruments=
|additional=${yyyyMmNow()}
}}`;

      setOutputs({ template, pageTitle: `${msg.author?.[0]?.family || "Unknown"} ${year} ${journal}` });
    }

    function copyTemplate() {
      document.getElementById("output").select();
      document.execCommand("copy");
      alert("Copied!");
    }

    function copyPageTitle() {
      document.getElementById("pagetitle").select();
      document.execCommand("copy");
      alert("Copied!");
    }
</script>
</body>
</html>