<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PubMed to BioBlast Template</title>
  <style>
    :root {
      --primary: #06038D;
      --background: #f7f7f9;
      --text: #333;
      --accent: #06038D;
      --border-radius: 8px;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background-color: var(--background);
      color: var(--text);
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2rem;
    }

    label {
      font-weight: 600;
      margin-top: 1rem;
    }

    input, button, textarea {
      width: 100%;
      max-width: 600px;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 1rem;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(6, 3, 141, 0.2);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #04026b;
    }

    textarea {
      height: 300px;
      margin-top: 1rem;
      resize: vertical;
    }

    .footer {
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .pagetitle-wrapper {
      display: flex;
      max-width: 600px;
      width: 100%;
      gap: 0.5rem;
    }

    .pagetitle-wrapper input { flex: 1; }

    .pagetitle-wrapper button {
      flex: 0 0 auto;
      padding: 0.75rem 1rem;
      width: auto;
    }

    .pagetitle-wrapper button:hover {
      background-color: #04026b;
    }
  </style>
</head>

<body>
  <h1>PubMed to BioBlast Template</h1>

  <label for="email">Your Email (required by NCBI)</label>
  <input id="email" placeholder="your.email@example.com" />

  <label for="pmid">PMID, PubMed Link, DOI, or DOI Link (e.g. Wiley)</label>
  <input id="pmid" placeholder="38177128 OR https://pubmed.ncbi.nlm.nih.gov/38177128 OR 10.1002/lci2.70003 OR https://onlinelibrary.wiley.com/doi/10.1002/lci2.70003" />

  <label for="editor">Editor (Lastname + First Initial, e.g., Doe J)</label>
  <input id="editor" placeholder="Doe J" />

  <button onclick="generateTemplate()">Generate Template</button>

  <label for="pagetitle">Generated Page Title</label>
  <div class="pagetitle-wrapper">
    <input id="pagetitle" readonly placeholder="Page title will appear here..." />
    <button onclick="copyPageTitle()">Copy</button>
  </div>

  <label for="output">Generated Template</label>
  <textarea id="output" readonly placeholder="Template will appear here..."></textarea>

  <button onclick="copyTemplate()">Copy to Clipboard</button>

  <div class="footer">
    Made with ðŸ’™ for Oroboros Instruments Â· <a href="https://pubmed.ncbi.nlm.nih.gov/" target="_blank">PubMed</a> API.
  </div>

  <script>
    async function generateTemplate() {
      const email = document.getElementById("email").value.trim();
      const input = document.getElementById("pmid").value.trim();
      const editor = document.getElementById("editor").value.trim() || "Plangger M";

      if (!email) { alert("Please enter your email (required by NCBI)."); return; }
      if (!input) { alert("Please enter a PMID, PubMed link, DOI, or DOI link."); return; }

      const pmid = extractPmid(input);     // strict: only PubMed URLs or pure digits
      const doi = extractDoi(input);       // DOI from anywhere (Wiley, doi.org, plain DOI)

      try {
        if (pmid) {
          // PubMed is best if you have it
          await generateFromPubMed({ pmid, editor });
        } else if (doi) {
          // DOI fallback (Wiley etc.)
          await generateFromCrossref({ doi, editor });
        } else {
          alert("Couldn't find a PMID (PubMed) or DOI in that input.");
        }
      } catch (e) {
        console.error(e);
        alert("Something went wrong while fetching metadata. See console for details.");
      }
    }

    // ---------- parsing helpers ----------
    function extractPmid(str) {
      const s = str.trim();

      // PubMed URL form
      if (/pubmed\.ncbi\.nlm\.nih\.gov/i.test(s)) {
        const m = s.match(/pubmed\.ncbi\.nlm\.nih\.gov\/(\d{5,})/i);
        return m ? m[1] : null;
      }

      // Pure digits form
      if (/^\d{5,}$/.test(s)) return s;

      return null;
    }

    function extractDoi(str) {
      const m = str.match(/10\.\d{4,9}\/[-._;()/:A-Z0-9]+/i);
      return m ? m[0] : null;
    }

    function cleanString(str) {
      return (str || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\x00-\x7F]/g, "");
    }

    // Convert Title Case -> sentence case:
    // "High-Resolution Respirometry in a Small-Volume Chamber"
    // -> "High-resolution respirometry in a small-volume chamber"
    // Keeps tokens that were ALLCAPS/NUMERIC in original (ATP, DNA, O2, IL-6, etc.)
    function toSentenceCase(title) {
      const original = (title || "").trim();
      if (!original) return "";

      let t = original.replace(/\s+/g, " ").toLowerCase();
      t = t.charAt(0).toUpperCase() + t.slice(1);

      // after colon
      t = t.replace(/:\s*([a-z])/g, (m, p1) => ": " + p1.toUpperCase());

      // restore obvious acronyms/formulas that were uppercase in the original
      const tokens = (original.match(/\b[A-Z0-9][A-Z0-9\-]{1,}\b/g) || []);
      for (const tok of tokens) {
        const escaped = tok.toLowerCase().replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
        const re = new RegExp(`\\b${escaped}\\b`, "g");
        t = t.replace(re, tok);
      }

      return t;
    }

    function yyyyMmNow() {
      return new Date().toISOString().slice(0, 7);
    }

    function setOutputs({ template, pageTitle }) {
      document.getElementById("output").value = template || "";
      document.getElementById("pagetitle").value = pageTitle || "";
    }

    // ---------- PubMed path ----------
    async function generateFromPubMed({ pmid, editor }) {
      const summaryResponse = await fetch(
        `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id=${pmid}&retmode=json`
      );
      const summaryData = await summaryResponse.json();
      const result = summaryData?.result?.[pmid];
      if (!result) { alert("No PubMed data found for that PMID."); return; }

      const journalAbbrev = result.source || "";
      const title = toSentenceCase(result.title || "");
      const year = (result.pubdate || "").slice(0, 4);
      const volume = result.volume || "";
      const pages = result.pages || "";
      const epubNotice = (!volume && !pages) ? "[Epub ahead of print]." : "";

      // DOI (best-effort from elocationid like "doi: 10.xxxx/yyy")
      const doi = (result.elocationid && result.elocationid.includes("doi")) ? result.elocationid : "";
      const pubmedUrl = `https://pubmed.ncbi.nlm.nih.gov/${pmid}`;
      const doiUrl = doi ? `https://doi.org/${doi.replace("doi: ", "")}` : "";

      const today = yyyyMmNow();

      // efetch XML for authors/abstract/keywords
      const fetchResponse = await fetch(
        `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pmid}&retmode=xml`
      );
      const fetchText = await fetchResponse.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(fetchText, "application/xml");

      const authorNodes = xmlDoc.querySelectorAll("AuthorList > Author");

      const authorsShort = Array.from(authorNodes).map(author => {
        const last = author.querySelector("LastName")?.textContent || "";
        const initials = author.querySelector("Initials")?.textContent || "";
        return cleanString(`${last} ${initials}`.trim());
      }).join(", ");

      const authorsFull = Array.from(authorNodes).map(author => {
        const last = author.querySelector("LastName")?.textContent || "";
        const fore = author.querySelector("ForeName")?.textContent || "";
        return cleanString(`${last} ${fore}`.trim());
      }).join(", ");

      // Abstract (multi-part)
      const abstractNodes = xmlDoc.querySelectorAll("Abstract > AbstractText");
      let abstract = "";
      if (abstractNodes.length > 0) {
        abstract = Array.from(abstractNodes)
          .map(node => node.textContent.trim())
          .join("\n");
      }

      // Keywords
      const keywordNodes = xmlDoc.querySelectorAll("KeywordList > Keyword");
      const keywords = Array.from(keywordNodes).map(n => n.textContent.trim()).join(", ");

      // PMCID -> Open Access marker (your rule)
      const pmcid = result.articleids?.find(id => id.idtype === "pmc")?.value;

      const template = `{{Publication
|title=${authorsShort} (${year}) ${title} ${journalAbbrev} ${volume && pages ? volume + ":" + pages + "." : ""}${epubNotice} ${doiUrl}
|info=[${pubmedUrl} PMID: ${pmid}${pmcid ? " Open Access" : ""}]
|authors=${authorsFull}
|year=${year}
|journal=${journalAbbrev}
|abstract=${abstract}
|keywords=${keywords}
|editor=[[${editor}]]
|mipnetlab=
}}
{{Labeling
|area=
|diseases=
|organism=
|tissues=
|preparations=
|couplingstates=
|pathways=
|instruments=
|additional=${today}
}}`;

      const firstAuthorLastName = authorNodes[0]?.querySelector("LastName")?.textContent || "Unknown";
      const pageTitle = `${firstAuthorLastName} ${year} ${journalAbbrev}`.trim();

      setOutputs({ template, pageTitle });
    }

    // ---------- Crossref path (DOI / Wiley / any publisher DOI) ----------
    async function generateFromCrossref({ doi, editor }) {
      const r = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`, {
        headers: { Accept: "application/json" }
      });
      if (!r.ok) { alert("Crossref lookup failed for that DOI."); return; }
      const data = await r.json();
      const msg = data?.message;
      if (!msg) { alert("No Crossref data found for that DOI."); return; }

      const journal = (msg["container-title"]?.[0] || "").trim();
      const rawTitle = toSentenceCase(msg.title?.[0] || "");
      const year =
        msg.published?.["date-parts"]?.[0]?.[0] ||
        msg["published-online"]?.["date-parts"]?.[0]?.[0] ||
        msg.created?.["date-parts"]?.[0]?.[0] ||
        "";

      const volume = (msg.volume || "").trim();
      const pages = (msg.page || "").trim();
      const doiUrl = msg.DOI ? `https://doi.org/${msg.DOI}` : `https://doi.org/${doi}`;
      const today = yyyyMmNow();

      const authors = (msg.author || []).map(a => {
        const last = cleanString((a.family || "").trim());
        const given = cleanString((a.given || "").trim());
        const initials = (given.match(/\b\p{L}/gu) || []).join("").toUpperCase();
        return { last, given, initials };
      });

      const authorsShort = authors.map(a => `${a.last} ${a.initials}`.trim()).filter(Boolean).join(", ");
      const authorsFull = authors.map(a => `${a.last} ${a.given}`.trim()).filter(Boolean).join(", ");

      // Abstract: sometimes present (often not). Strip tags if present.
      let abstract = (msg.abstract || "")
        .replace(/<[^>]+>/g, "")
        .replace(/\s+\n/g, "\n")
        .trim();

      // Keywords: usually not present in Crossref -> keep blank
      const keywords = "";

      // Use publisher landing page if available; else DOI URL
      const landing = msg.URL ? msg.URL : "";
      const infoLink = landing ? landing : doiUrl;

      const template = `{{Publication
|title=${authorsShort} (${year}) ${rawTitle} ${journal} ${volume && pages ? volume + ":" + pages + "." : ""} ${doiUrl}
|info=[${infoLink} DOI: ${doi}]
|authors=${authorsFull}
|year=${year}
|journal=${journal}
|abstract=${abstract}
|keywords=${keywords}
|editor=[[${editor}]]
|mipnetlab=
}}
{{Labeling
|area=
|diseases=
|organism=
|tissues=
|preparations=
|couplingstates=
|pathways=
|instruments=
|additional=${today}
}}`;

      const firstAuthor = authors[0]?.last || "Unknown";
      const pageTitle = `${firstAuthor} ${year} ${journal}`.trim();

      setOutputs({ template, pageTitle });
    }

    // ---------- copy buttons ----------
    function copyTemplate() {
      const text = document.getElementById("output");
      text.select();
      document.execCommand("copy");
      alert("Template copied to clipboard!");
    }

    function copyPageTitle() {
      const titleField = document.getElementById("pagetitle");
      titleField.select();
      document.execCommand("copy");
      alert("Page Title copied to clipboard!");
    }
  </script>
</body>
</html>
